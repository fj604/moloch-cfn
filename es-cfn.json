{
    "AWSTemplateFormatVersion": "2010-09-09",

    "Description": "Create an ElasticSearch domain",
    "Parameters": {
        "VpcId" : {
            "Type" : "AWS::EC2::VPC::Id",
            "Description" : "VpcId of your existing Virtual Private Cloud (VPC)",
            "ConstraintDescription" : "must be the VPC Id of an existing Virtual Private Cloud."
        },
        "Subnets" : {
            "Type" : "List<AWS::EC2::Subnet::Id>",
            "Description" : "The list of SubnetIds in your Virtual Private Cloud (VPC)",
            "ConstraintDescription" : "must be a list of existing subnets associated with at different availability zones. They should be residing in the selected VPC."
        },
        "Version" : {
            "Type" : "String",
            "Default": "7.1",
            "AllowedValues": [
                "6.7",
                "6.8",
                "7.1"
            ],
            "Description" : "ElasticSearch version"
        },
        "InstanceType": {
            "Type": "String",
            "Default": "t2.small.elasticsearch",
            "AllowedValues": [
                "t2.small.elasticsearch",
                "t2.medium.elasticsearch",
                "m5.large.elasticsearch",
                "m4.large.elasticsearch",
                "c5.large.elasticsearch",
                "r5.large.elasticsearch",
                "r4.large.elasticsearch",
                "i3.large.elasticsearch"
            ],
            "Description": "Enter ElasticSearch instance type"
        },
        "InstanceCount": {
            "Type": "Number",
            "Description": "Number of ElasticSearch instances",
            "Default": 1
        },
        "VolumeSize": {
            "Type": "Number",
            "Description": "EBS Volume size in GB",
            "Default": 10
        },

        "ESLocation": {
            "Type": "String",
            "Default": "0.0.0.0/0",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x.",
            "Description": "Allow ElasticSearch traffic to from x.x.x.x/x",
            "MaxLength": "18",
            "MinLength": "9"
        }
    },
    "Resources": {
        "ESSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable ElasticSearch port 443",
                "SecurityGroupIngress": [
                    {
                        "CidrIp": {
                            "Ref": "ESLocation"
                        },
                        "FromPort": 443,
                        "IpProtocol": "tcp",
                        "ToPort": 443
                    }
                ],
                "VpcId": { "Ref": "VpcId" }
            }
        },
        "ElasticSearchDomain": {
            "Type" : "AWS::Elasticsearch::Domain",
            "Properties" : {
                "AccessPolicies": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                              "AWS": "*"
                            },
                            "Action": "es:*",
                            "Resource": "arn:aws:es:eu-west-2:865692964153:domain/farhad-elasti-1n847m5iwhfmi/*"
                        }
                    ]
                },
                "ElasticsearchClusterConfig" : {
                    "InstanceCount": {"Ref": "InstanceCount"},
                    "InstanceType": {"Ref": "InstanceType"}
                },
                "EBSOptions": {
                    "EBSEnabled": true,
                    "VolumeSize": {"Ref": "VolumeSize"}
                },
                "ElasticsearchVersion" : {"Ref": "Version"},
                "VPCOptions" : {
                    "SecurityGroupIds": [
                        { "Ref": "ESSecurityGroup" }
                    ],
                    "SubnetIds": {"Ref": "Subnets"}
                }
            }
        }
    },
    "Outputs": {
        "Endpoint": {
            "Description": "ElasticSearch Endpoint URL",
            "Value": { "Fn::GetAtt": ["ElasticSearchDomain", "DomainEndpoint"] }
        }
    }
}